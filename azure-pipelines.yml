trigger:
- master

stages:

- stage: ver
  displayName: Determine Version
  steps:

  - task: gitversion/setup@0
    displayName: Install GitVersion
    inputs:
      versionSpec: '5.x'

  - task: gitversion/execute@0
    displayName: Determine Version
    inputs:
      useConfigFile: true
      configFilePath: 'GitVersion.yml'
    name: version

- stage: test
  displayName: Test
  jobs:

  - template: scripts/build.yml
    parameters:
      name: Linux_net50
      displayName: Linux - net5.0
      framework: net5.0
      appFramework: net5.0
      pool:
        vmImage: 'ubuntu-latest'
      assemblyVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemVer'] ]
      fileVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemFileVer'] ]
      informationalVersion: $[ dependencies.ver.outputs['version.GitVersion.InformationalVersion'] ]

  - template: scripts/build.yml
    parameters:
      name: macOS_net50
      displayName: macOS - net5.0
      framework: net5.0
      appFramework: net5.0
      pool:
        vmImage: 'macOS-latest'
      assemblyVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemVer'] ]
      fileVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemFileVer'] ]
      informationalVersion: $[ dependencies.ver.outputs['version.GitVersion.InformationalVersion'] ]

  - template: scripts/build.yml
    parameters:
      name: Windows_net50
      displayName: Windows - net5.0
      framework: net5.0
      appFramework: net5.0
      pool:
        vmImage: 'windows-latest'
      assemblyVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemVer'] ]
      fileVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemFileVer'] ]
      informationalVersion: $[ dependencies.ver.outputs['version.GitVersion.InformationalVersion'] ]

  - template: scripts/build.yml
    parameters:
      name: Windows_net452
      displayName: Windows - net452
      framework: net452
      appFramework: net452
      pool:
        vmImage: 'windows-latest'
      assemblyVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemVer'] ]
      fileVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemFileVer'] ]
      informationalVersion: $[ dependencies.ver.outputs['version.GitVersion.InformationalVersion'] ]

- stage: pack
  displayName: Pack
  dependsOn: test
  jobs:

  - template: scripts/pack.yml
    parameters:
      name: 'pack'
      displayName: 'Pack Certes'
      projectName: 'Certes'
      assemblyVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemVer'] ]
      fileVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemFileVer'] ]
      informationalVersion: $[ dependencies.ver.outputs['version.GitVersion.InformationalVersion'] ]

  - template: scripts/pack.yml
    parameters:
      name: 'pack_tool'
      displayName: 'Pack Certes.Tool'
      projectName: 'Certes.Cli'
      assemblyVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemVer'] ]
      fileVersion: $[ dependencies.ver.outputs['version.GitVersion.AssemblySemFileVer'] ]
      informationalVersion: $[ dependencies.ver.outputs['version.GitVersion.InformationalVersion'] ]
